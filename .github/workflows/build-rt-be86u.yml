name: Build RT-BE86U Firmware

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g. 3006.102.6). Leave empty to auto-detect latest 3006* tag.'
        required: false
        default: ''

jobs:
  check-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
      should_build: ${{ steps.resolve.outputs.should_build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve tag
        id: resolve
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "Using manually specified tag: ${TAG}"
            exit 0
          fi

          LATEST_TAG=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/RMerl/asuswrt-merlin.ng/tags?per_page=100" \
            | jq -r '[.[].name | select(startswith("3006"))] | sort_by(split(".") | map(split("-")[0] | gsub("[^0-9]"; "") | if . == "" then 0 else tonumber end)) | last // empty')

          if [ -z "${LATEST_TAG}" ]; then
            echo "No tag starting with 3006 found."
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Latest 3006* tag: ${LATEST_TAG}"

          LAST_BUILT_TAG=""
          if [ -f .last_built_tag ]; then
            LAST_BUILT_TAG=$(cat .last_built_tag)
          fi

          if [ "${LATEST_TAG}" = "${LAST_BUILT_TAG}" ]; then
            echo "Tag ${LATEST_TAG} has already been built. Skipping."
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          else
            echo "New tag detected: ${LATEST_TAG}"
            echo "tag=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: check-tag
    if: needs.check-tag.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image from Dockerfile
        run: docker build -t asuswrt-merlin-toolchains .

      - name: Clone asuswrt-merlin.ng source
        run: |
          TAG="${{ needs.check-tag.outputs.tag }}"
          git clone --depth 1 --branch "${TAG}" https://github.com/RMerl/asuswrt-merlin.ng.git ~/asuswrt-merlin.ng

      - name: Apply xt_owner kernel config patch
        run: |
          cd ~/asuswrt-merlin.ng

          # Patch kernel configs for RT-BE86U platform (96813) to enable xt_owner
          find . -path "*/kernel/linux-*/arch/arm64/configs/*" \( -name "*96813*" -o -name "*defconfig*" \) | while IFS= read -r cfg; do
            if grep -q "CONFIG_NETFILTER_XT_MATCH_OWNER" "$cfg"; then
              sed -i 's/.*CONFIG_NETFILTER_XT_MATCH_OWNER.*/CONFIG_NETFILTER_XT_MATCH_OWNER=m/' "$cfg"
              echo "Patched existing CONFIG_NETFILTER_XT_MATCH_OWNER in $cfg"
            else
              echo "CONFIG_NETFILTER_XT_MATCH_OWNER=m" >> "$cfg"
              echo "Added CONFIG_NETFILTER_XT_MATCH_OWNER=m to $cfg"
            fi
          done

          find . \( -path "*bcm_96813*" -name ".config" \) -o -path "*96813*defconfig*" | while IFS= read -r cfg; do
            if [ -f "$cfg" ]; then
              if grep -q "CONFIG_NETFILTER_XT_MATCH_OWNER" "$cfg"; then
                sed -i 's/.*CONFIG_NETFILTER_XT_MATCH_OWNER.*/CONFIG_NETFILTER_XT_MATCH_OWNER=m/' "$cfg"
                echo "Patched existing CONFIG_NETFILTER_XT_MATCH_OWNER in $cfg"
              else
                echo "CONFIG_NETFILTER_XT_MATCH_OWNER=m" >> "$cfg"
                echo "Added CONFIG_NETFILTER_XT_MATCH_OWNER=m to $cfg"
              fi
            fi
          done

          find . -path "*/linux/config_*" -type f | while IFS= read -r cfg; do
            if grep -q "CONFIG_NETFILTER" "$cfg"; then
              if ! grep -q "CONFIG_NETFILTER_XT_MATCH_OWNER" "$cfg"; then
                echo "CONFIG_NETFILTER_XT_MATCH_OWNER=m" >> "$cfg"
                echo "Added CONFIG_NETFILTER_XT_MATCH_OWNER=m to $cfg"
              fi
            fi
          done

      - name: Patch prebuild_checks to allow root build in CI
        run: |
          PREBUILD_CHECKS=~/asuswrt-merlin.ng/release/src-rt-5.04behnd.4916/build/prebuild_checks.mk
          if [ -f "$PREBUILD_CHECKS" ]; then
            sed -i '/Attempting to build as root/,/fi/s/exit 1/true/' "$PREBUILD_CHECKS"
            if grep -q 'Attempting to build as root' "$PREBUILD_CHECKS" && ! grep -q 'exit 1' "$PREBUILD_CHECKS"; then
              echo "Patched prebuild_checks.mk to allow building as root in CI"
            else
              echo "WARNING: prebuild_checks.mk patch may not have been applied correctly"
            fi
          fi

      - name: Build RT-BE86U firmware
        run: |
          docker run --rm \
            -v "$HOME/asuswrt-merlin.ng:/build/asuswrt-merlin.ng" \
            --user root \
            asuswrt-merlin-toolchains \
            bash -c '
              set -o pipefail
              ln -sf /home/docker/am-toolchains/brcm-arm-hnd /opt/toolchains
              export LD_LIBRARY_PATH=/opt/toolchains/crosstools-arm_softfp-gcc-10.3-linux-4.19-glibc-2.32-binutils-2.36.1/usr/lib
              export TOOLCHAIN_BASE=/opt/toolchains
              export PATH=$PATH:/opt/toolchains/crosstools-aarch64-gcc-10.3-linux-4.19-glibc-2.32-binutils-2.36.1/usr/bin
              export PATH=$PATH:/opt/toolchains/crosstools-arm_softfp-gcc-10.3-linux-4.19-glibc-2.32-binutils-2.36.1/usr/bin
              cd /build/asuswrt-merlin.ng/release/src-rt-5.04behnd.4916
              make rt-be86u 2>&1 | tee /build/asuswrt-merlin.ng/build.log
            '

      - name: Collect firmware artifacts
        id: collect
        run: |
          TAG="${{ needs.check-tag.outputs.tag }}"
          mkdir -p ~/firmware
          find ~/asuswrt-merlin.ng/release/src-rt-5.04behnd.4916/image -type f \( -name "*.trx" -o -name "*.w" -o -name "*.pkgtb" \) \
            -exec cp {} ~/firmware/ \; 2>/dev/null || true
          find ~/asuswrt-merlin.ng/release/src-rt-5.04behnd.4916 -maxdepth 3 -type f -name "*BE86U*" \
            -exec cp {} ~/firmware/ \; 2>/dev/null || true
          ls -la ~/firmware/
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "firmware_path=$(realpath ~/firmware)" >> "$GITHUB_OUTPUT"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: RT-BE86U-firmware-${{ needs.check-tag.outputs.tag }}
          path: ${{ steps.collect.outputs.firmware_path }}
          retention-days: 30

  release:
    needs: [check-tag, build]
    if: needs.check-tag.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download firmware artifact
        uses: actions/download-artifact@v4.1.7
        with:
          name: RT-BE86U-firmware-${{ needs.check-tag.outputs.tag }}
          path: firmware

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: RT-BE86U-${{ needs.check-tag.outputs.tag }}
          name: RT-BE86U Firmware ${{ needs.check-tag.outputs.tag }}
          body: |
            RT-BE86U firmware built from asuswrt-merlin.ng tag `${{ needs.check-tag.outputs.tag }}`.

            **Patches applied:**
            - Enabled `CONFIG_NETFILTER_XT_MATCH_OWNER=m` (xt_owner kernel module)
            - iptables 1.4.x already includes built-in owner match extension support (libxt_owner.so)
          files: firmware/*
          draft: false
          prerelease: ${{ contains(needs.check-tag.outputs.tag, 'beta') }}

      - name: Update last built tag
        run: |
          echo "${{ needs.check-tag.outputs.tag }}" > .last_built_tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_built_tag
          git diff --cached --quiet || git commit -m "Update last built tag to ${{ needs.check-tag.outputs.tag }}"
          git push
